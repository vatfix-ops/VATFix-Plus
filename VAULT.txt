# ğŸ” VATFix VAULT

Internal mechanics, trade secrets & integration tips for the elite. **DO NOT PUBLICIZE.**

---

## ğŸ”‘ API Keys & Billing

* API keys are minted post-purchase via Stripe.
* Each key is bound to a `customer_email`.
* Headers `x-api-key` and `x-customer-email` are **mandatory**.
* Rate limits: **120 requests/min** per key. Spikes over limit â†’ `429 rate_limit_exceeded`.

---

## ğŸ§  Cache & Fallback

* **S3-backed cache + logs**:

  * 12h cache window per VAT number.
  * Long-term audit logging in S3 bucket `vatfix-plus`.
* All successful lookups cached by `countryCode + vatNumber`.

---

## ğŸŒ Fallback Logic

* If VIES API is down:

  * Retry 3Ã— across EU mirrors.
  * On total failure: serve stale cache if <12h old.
  * Else: return `{ valid: null, error: "vies_unavailable" }`.

---

## ğŸ§© Code Structure

* `server.mjs` â€“ Express server
* `lib/validate.js` â€“ VAT validation engine
* `webhook.js` â€“ Stripe billing sync & revocation
* `lib/meter.js` â€“ Per-key throttling & quota
* `lib/entitlement.js` â€“ Plan detection & access rules
* `lib/success.js` â€“ Post-checkout handling

---

## ğŸ“¦ Deployments

**Platform:** Fly.io

* Auto-scale across EU edge regions.
* `fly.toml` defines regions, resources, env vars.
* Logs visible in `fly logs` (optionally export to S3 for retention).

---

## ğŸ§ª Test Scenarios

### 1. Valid EU VAT

```json
{"countryCode": "DE", "vatNumber": "123456789"}
```

Expected â†’ `valid: true` with name/address.

### 2. Invalid VAT

```json
{"countryCode": "FR", "vatNumber": "FAKE000000"}
```

Expected â†’ `valid: false`.

### 3. Rate Limit

Flood a single key >120 RPM â†’ expect `429`.

### 4. Missing headers

Omit `x-api-key` â†’ expect `401`.

---

## ğŸ¤« Secrets

* Stripe secret â†’ `STRIPE_SECRET_KEY` in Fly secrets
* Webhook secret â†’ `STRIPE_WEBHOOK_SECRET`
* S3 access keys + bucket in `.env` (**never committed**)

---

## ğŸ§­ Internal Docs

* See `INSTRUCTIONS.md` for deployment.
* Public GitHub `README.md` is customer-facing â€” **keep VAULT private.**

Stay secret. Stay sovereign. ğŸ›¡ï¸
